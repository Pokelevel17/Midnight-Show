<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Midnight Swim</title>
<style>
  html,body {
    margin:0;
    height:100%;
    background:#000;
    overflow:hidden;
    font-family:"Helvetica Neue",Arial,sans-serif;
    color:#fff;
  }
  #video-container {
    position:fixed;
    inset:0;
    background:#000;
  }
  iframe {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
  }
  .static {
    position:absolute;
    inset:0;
    background:url('https://upload.wikimedia.org/wikipedia/commons/d/d1/Static.gif') center/cover no-repeat;
    opacity:0;
    transition:opacity 0.5s ease;
    z-index:10;
    pointer-events:none;
  }
  .show { opacity:1; }
  .title {
    position:absolute;
    top:16px;
    left:20px;
    z-index:20;
    text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;
  }
  .title h1 {
    font-size:28px;
    margin:0;
    text-transform:uppercase;
    letter-spacing:2px;
  }
  .now-playing {
    margin-top:4px;
    font-size:14px;
    opacity:0.85;
  }
  .next-playing {
    position:absolute;
    bottom:20px;
    left:20px;
    font-size:13px;
    opacity:0.75;
    text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;
  }
</style>
</head>
<body>
<div id="video-container"></div>
<div class="static" id="static"></div>

<div class="title">
  <h1>MIDNIGHT SWIM</h1>
  <div class="now-playing" id="nowText">Loading lineup...</div>
</div>
<div class="next-playing" id="nextText"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let playlist = [];
let titles = {};
let current = 0;
let player = null;
let staticEl = document.getElementById("static");

async function loadVideos() {
  try {
    const res = await fetch("Videos.json");
    const data = await res.json();
    playlist = shuffle(data.videos.map(v => v.id));
    data.videos.forEach(v => titles[v.id] = v.title || "Untitled");
    onYouTubeIframeAPIReady();
  } catch(e) {
    console.error("Error loading videos:", e);
  }
}

function shuffle(a) {
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function onYouTubeIframeAPIReady() {
  playNext();
}

function playNext() {
  const videoId = playlist[current];
  const nextId = playlist[(current+1)%playlist.length];
  document.getElementById("nowText").textContent = "Now Playing: " + (titles[videoId] || "Unknown");
  document.getElementById("nextText").textContent = "Next: " + (titles[nextId] || "Unknown");

  if(player) player.destroy();

  player = new YT.Player('video-container', {
    videoId: videoId,
    playerVars: {
      autoplay: 1,
      controls: 0,
      rel: 0,
      modestbranding: 1,
      iv_load_policy: 3,
      playsinline: 1,
      fs: 0,
      vq: 'hd1080'
    },
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange
    }
  });
}

// Show static for first and last 5 seconds dynamically
function onPlayerReady(event) {
  player.playVideo();
  staticEl.classList.add("show"); // first 5 seconds
  setTimeout(() => staticEl.classList.remove("show"), 5000);

  // Start checking current time for last 5 seconds
  const checkInterval = setInterval(() => {
    const duration = player.getDuration();
    const currentTime = player.getCurrentTime();
    if(duration - currentTime <= 5) {
      staticEl.classList.add("show");
    } else {
      staticEl.classList.remove("show");
    }
  }, 200);

  // Save interval to clear later
  player.checkInterval = checkInterval;
}

function onPlayerStateChange(event) {
  if(event.data === YT.PlayerState.ENDED) {
    if(player.checkInterval) clearInterval(player.checkInterval);
    current = (current+1)%playlist.length;
    playNext();
  }
}

loadVideos();
</script>
</body>
</html>
